var BS = {
    game : {
        gameId : 0,
        interval : 100,
        currentUser : 0,
        currentShot : 0,
        data :{},	
        getData : function(gameId) {
            console.log('Getting data');
            this.gameId = gameId;
            var that = this;
            $.ajax({
                url: '/game/' + gameId + '/stats',
                cache: false,
                //type : 'json', 
                success : function(data) {
                    console.log('HERE');
                    that.data = data;
                    console.log(that.data);
                    that.sizeX = data.width;
                    that.sizeY = data.height;
                    that.numOfFields = that.sizeX * that.sizeY;
                    that.drawBoards();
                    that.showNextShot();
                },
                error : function (a,b,c) {
                    console.log(a);
                    console.log(b);
                    console.log(c);
                }
            });
        },
        
        showNextShot : function () {
            var i = 0;
            //console.log(this);
            for(i = 0; i < this.data.boards.length; i++){
                if(typeof(this.data.boards[i].shoots[this.currentShot]) !== 'undefined') {
                    this.shot(this.data.boards[i].id, this.data.boards[i].shoots[this.currentShot], this.currentShot + 1);
                }
            } 
            this.currentShot += 1;
            if (this.currentShot <= this.numOfFields) {
                var that=this;
                var t = setTimeout(function(){that.showNextShot();},that.interval);
            }
        },
        
        drawBoard : function (id, name) {
            var i = 0;
            var j = 0;
            var h = '<div class="playerContainer" id="container' + id + '"><h2>' + name + '</h2><table class="board" id="board' + id + '">';
            for(i = 0; i < this.sizeY; i++){
                h += '<tr>';
                for(j = 0; j < this.sizeX; j++){
                    h += '<td><div class="empty"></div></td>';
                }
                h += '</tr>';
            }
            h += '</table><h3>Game log</h3><ul id="log' + id + '"></ul></div>';
            return h;
        },
        
        drawBoards : function () {
            var i = 0;
            for(i = 0; i < this.data.boards.length; i++){
                $('.body').append(this.drawBoard(this.data.boards[i].id, this.data.players[i].name));
            }
            $('.body').append('<div class="clear"></div>');
        },
        
        shot : function (id, data, num) {
            var elem=$('#board' + id + ' tr').eq(data.y).find('td').eq(data.x);
            var shotStatus = data.result;
            if ($(elem).find('div.empty').length === 0){
                shotStatus = 'samespot';
            }
            $(elem).html('<div class="ship_' + data.shipId + ' '  + shotStatus + '"></div>');
            console.log(shotStatus);
            if (shotStatus === 'sunk') {
                console.log(shotStatus);
                $('#board' + id +' .ship_' + data.shipId).removeClass('hit').addClass('hitsunk');
            }
            
            //Ad log
            var html ='<li class="shotStatus ' + shotStatus + '">Shot ' + num + ' - x:' + data.x + ' y:' + data.y;
            switch(shotStatus){
                case 'miss' :
                    html += ' - miss';
                break;
                case 'hit' :
                    html += ' - hit ' + data.shipType + '!';
                break;
                case 'hitsunk' :
                    html += ' - hit and sunk ' + data.shipType + '!!!';
                break;
                case 'samespot' :
                    html += ' - hit spot that was hit before - BUUUUU!';
                break;
            } 
            html += '</li>';
            $('#log' + id).prepend(html);
        },

        displayGame : function (gameId) {
            this.getData(gameId);
            //this.drawBoards();
            
        }
    },

    arrange : {
        drawBoard : function(sizeX, sizeY, positions) {
            $board = $('<ul/>');
            $board.css({width: (sizeX * 11) + 'px', height: (sizeY * 11) + 'px'});
            for (var y = 0; y < sizeY; y++) {
                for (var x = 0; x < sizeX; x++) {
                    $('<li/>', {x: x, y: y}).addClass(x.toString() + '-' + y.toString()).appendTo($board);
                }
            }
            $.each(positions, function (index, value) {
                $board.find('li.' + value.x + '-' + value.y).addClass('position');
            });
            $('.board').append($board);
        }

    },
	

    showPage : function (nameOfPage) {
        $('.body').load('/ui/pages/' + nameOfPage + '.html', function(response, status) {
            if (status === 'error') {
                console.log('Page ' + nameOfPage + ' does not exist');
            } else {
                if ($.isFunction(BS._pageInitializers[nameOfPage])) {
                    BS._pageInitializers[nameOfPage].call(BS);
                }
            }
        });
    },

    _pageInitializers : {
        showGame : function() {
            BS.game.displayGame(10);
        },

        userZone : function() {
            var $shipTemplate = $('<ul/>').addClass('ship');
            for (var y = 0; y < 8; y++) {
                for (var x = 0; x < 8; x++) {
                    $('<li/>', {x: x, y: y}).addClass(x.toString() + '-' + y.toString()).appendTo($shipTemplate);
                }
            }
            $.ajax({
                url: '/ship/list',
                cache: false,
                success : function(data) {
                    $.each(data, function (index, value) {
                       var type = index;
                       $.each(value, function(index, value) {
                           var variant = index; 
                           var $ship = $shipTemplate.clone();
                           $ship.attr('type', type);
                           $ship.attr('variant', variant);
                           $.each(value, function (index, value) {
                               $ship.find('.' + value.x + '-' + value.y).addClass('shape');
                           });
                           var size = 
                           $('.available-ships').append($ship);
                       });
                    });
                    $('.available-ships .ship').dragdrop({
                        clone: true,
                        dragClass: 'dragging',
                        canDrop : function(dst, src) {
                            $('.board .decision, .board .impossible').removeClass('decision impossible');
                            var dstx, dsty, impossible = false;
                            if (dst.is('.board li')) {
                                dstx = parseInt(dst.attr('x'));
                                dsty = parseInt(dst.attr('y'));
                                src.find('li.shape').each(function () {
                                    var $field = $('.board .' + (parseInt($(this).attr('x')) + dstx) + '-' + (parseInt($(this).attr('y')) + dsty));
                                    if ($field.length > 0) {
                                        $field.addClass('decision'); 
                                    } else {
                                        impossible = true;
                                    }
                                });
                                if (impossible) {
                                    $('.board .decision').addClass('impossible');
                                } else {
                                    return true;
                                }
                            } 
                            return false;
                        },
                        didDrop : function(src, dst) {
                            var token = $('input#token').val(),
                                gameId = $('input#game_id').val(),
                                dstx = parseInt(dst.attr('x')),
                                dsty = parseInt(dst.attr('y')),
                                type = src.attr('type'),
                                variant = src.attr('variant');
                            console.log('Dropped ' + type + ' variant ' + variant + ', x=' + dstx + ', y=' + dsty);
                            $.ajax({
                                url: '/' + token + '/game/' + gameId  + '/set?ships[][type]=' + type + '&ships[][variant]=' + variant + '&ships[][xy][]=' + dstx + '&ships[][xy][]=' + dsty,
                                cache: false,
                                success : function(data) {
                                    if (data && data.status && data.status == 'created') {
                                        $('.board .decision').addClass('position').removeClass('decision');
                                        console.log('Succesfull placement');
                                    } else {
                                        $('.board .decision, .board .impossible').removeClass('decision impossible');
                                        console.log('Placement not possible');
                                    }

                                }
                            });
                        }
                    });
                },
                error : function (a,b,c) {
                    console.log(a);
                    console.log(b);
                    console.log(c);
                }
            });

            $('#show_board_btn').click(function () {
                var token = $('#token').val();
                var gameId = $('#game_id').val();



                $.ajax({
                    url: '/' + token + '/game/' + gameId,
                    cache: false,
                    //type : 'json', 
                    success : function(gameData) {
                        $.ajax({
                            url: '/' + token + '/game/' + gameId + '/show.json',
                            cache: false,
                            //type : 'json', 
                            success : function(positionsData) {
                                BS.arrange.drawBoard(gameData.width, gameData.height, positionsData);
                            }
                        });
                    }
                });
            });
        }
    }
};


$(function(){
	//$('.body').append(BS.game.drawBoard(1));

    $('.menu li a').click(function () {
        var menuCommand = $(this).attr('rel');
        BS.showPage(menuCommand);
    });

    //BS.showPage("userZone");
    BS.showPage("showGame");

	
});
